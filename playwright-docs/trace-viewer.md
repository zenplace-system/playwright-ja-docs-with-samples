# Playwrightトレースビューアー

## 概要

Playwrightトレースビューアーは、スクリプト実行後に記録されたPlaywrightトレースを探索するためのGUIツールです。トレースは、CIでテストが失敗した場合のデバッグに最適な方法です。トレースは[ローカル](#トレースビューアーの開き方)または[trace.playwright.dev](https://trace.playwright.dev)のブラウザで開くことができます。

## トレースビューアーの開き方

保存されたトレースは、Playwright CLIまたは[trace.playwright.dev](https://trace.playwright.dev)のブラウザで開くことができます。`trace.zip`ファイルの場所へのフルパスを指定してください。

```bash
npx playwright show-trace path/to/trace.zip
```

### [trace.playwright.dev](https://trace.playwright.dev)の使用

[trace.playwright.dev](https://trace.playwright.dev)は、トレースビューアーの静的にホストされたバリアントです。ドラッグアンドドロップまたは「Select file(s)」ボタンを使用してトレースファイルをアップロードできます。

トレースビューアーはトレースを完全にブラウザ内に読み込み、外部にデータを送信しません。

### リモートトレースの表示

URLを使用して直接リモートトレースを開くことができます。これにより、例えばCIランからファイルを手動でダウンロードすることなく、リモートトレースを簡単に表示できます。

```bash
npx playwright show-trace https://example.com/trace.zip
```

[trace.playwright.dev](https://trace.playwright.dev)を使用する場合、アクセス可能なストレージ（例：CI内部）にアップロードされたトレースのURLをクエリパラメータとして渡すこともできます。CORS（クロスオリジンリソース共有）ルールが適用される場合があります。

```
https://trace.playwright.dev/?trace=https://demo.playwright.dev/reports/todomvc/data/fa874b0d59cdedec675521c21124e93161d66533.zip
```

## トレースの記録

### ローカルでのトレース

開発モード中にトレースを記録するには、テスト実行時に`--trace`フラグを`on`に設定します。より良い開発者体験のために[UIモード](/docs/test-ui-mode)を使用することもできます。UIモードでは各テストが自動的にトレースされます。

```bash
npx playwright test --trace on
```

その後、HTMLレポートを開き、トレースアイコンをクリックしてトレースを開くことができます。

```bash
npx playwright show-report
```

### CI上でのトレース

トレースは、テスト設定ファイルで`trace: 'on-first-retry'`オプションを設定することで、失敗したテストの最初の再試行時に継続的インテグレーション上で実行する必要があります。これにより、再試行された各テストに対して`trace.zip`ファイルが生成されます。

```javascript
// playwright.config.js
module.exports = {
  retries: 1,
  use: {
    trace: 'on-first-retry',
  },
};
```

テストランナーを使用しない場合は、代わりに[browserContext.tracing](/docs/api/class-browsercontext#browser-context-tracing) APIを使用します：

```javascript
const browser = await chromium.launch();
const context = await browser.newContext();

// ページの作成/ナビゲーション前にトレースを開始
await context.tracing.start({ screenshots: true, snapshots: true });
const page = await context.newPage();
await page.goto('https://playwright.dev');

// トレースを停止してzipアーカイブにエクスポート
await context.tracing.stop({ path: 'trace.zip' });
```

トレースを記録するための利用可能なオプション：

* `'on-first-retry'` - 最初のテスト再試行時にのみトレースを記録
* `'on-all-retries'` - すべてのテスト再試行でトレースを記録
* `'off'` - トレースを記録しない
* `'on'` - 各テストのトレースを記録（パフォーマンスが重いため推奨されません）
* `'retain-on-failure'` - 各テストのトレースを記録するが、成功したテスト実行からは削除

再試行を有効にしていなくても、失敗したテストのトレースが必要な場合は、`trace: 'retain-on-failure'`を使用することもできます。

より詳細なオプションについては、[testOptions.trace](/docs/api/class-testoptions#test-options-trace)を参照してください。

## トレースビューアーの機能

### アクション

アクションタブでは、各アクションに使用されたロケーターと実行にかかった時間を確認できます。テストの各アクションにホバーすると、DOMスナップショットの変化を視覚的に確認できます。時間を前後に移動し、アクションをクリックして検査およびデバッグします。「Before」と「After」タブを使用して、アクションの前後に何が起こったかを視覚的に確認できます。

**各アクションを選択すると表示されるもの：**
* アクションスナップショット
* アクションログ
* ソースコードの場所

### スクリーンショット

[screenshots](/docs/api/class-tracing#tracing-start-option-screenshots)オプションをオンにしてトレースする場合（デフォルト）、各トレースはスクリーンキャストを記録し、フィルムストリップとしてレンダリングします。フィルムストリップにホバーすると、各アクションと状態の拡大画像が表示され、検査したいアクションを簡単に見つけることができます。

アクションをダブルクリックすると、そのアクションの時間範囲が表示されます。タイムラインのスライダーを使用して選択されたアクションを増やすことができ、これらはアクションタブに表示され、すべてのコンソールログとネットワークログは選択されたアクションのログのみを表示するようにフィルタリングされます。

### スナップショット

[snapshots](/docs/api/class-tracing#tracing-start-option-snapshots)オプションをオンにしてトレースする場合（デフォルト）、Playwrightは各アクションに対して完全なDOMスナップショットのセットをキャプチャします。アクションのタイプに応じて、以下をキャプチャします：

| タイプ | 説明 |
|------|------|
| Before | アクションが呼び出された時点のスナップショット |
| Action | 入力が実行された瞬間のスナップショット。このタイプのスナップショットは、Playwrightがどこをクリックしたかを正確に探索する際に特に役立ちます |
| After | アクション後のスナップショット |

### ソース

サイドバーでアクションをクリックすると、そのアクションのコード行がソースパネルでハイライト表示されます。

### コール

コールタブには、アクションに関する情報（所要時間、使用されたロケーター、strictモードかどうか、使用されたキーなど）が表示されます。

### ログ

テストの完全なログを確認して、Playwrightがビューへのスクロール、要素の表示、有効化、安定化の待機、クリック、入力、キー押下などのアクションの実行など、バックグラウンドで何をしているかをよりよく理解できます。

### エラー

テストが失敗した場合、エラータブに各テストのエラーメッセージが表示されます。タイムラインにもエラーが発生した場所を示す赤い線が表示されます。ソースタブをクリックして、ソースコードのどの行にエラーがあるかを確認することもできます。

### コンソール

ブラウザからのコンソールログとテストからのコンソールログを確認できます。コンソールログがブラウザから来たのかテストファイルから来たのかを示す異なるアイコンが表示されます。

テストのアクションサイドバーからアクションをダブルクリックします。これにより、コンソールがフィルタリングされ、そのアクション中に行われたログのみが表示されます。「Show all」ボタンをクリックすると、すべてのコンソールログが再び表示されます。

タイムラインを使用してアクションをフィルタリングするには、開始点をクリックしてエンドポイントまでドラッグします。コンソールタブもフィルタリングされ、選択されたアクション中に行われたログのみが表示されます。

### ネットワーク

ネットワークタブには、テスト中に行われたすべてのネットワークリクエストが表示されます。リクエストの種類、ステータスコード、メソッド、リクエスト、コンテンツタイプ、所要時間、サイズでソートできます。リクエストをクリックすると、リクエストヘッダー、レスポンスヘッダー、リクエスト本文、レスポンス本文などの詳細情報が表示されます。

テストのアクションサイドバーからアクションをダブルクリックします。これにより、ネットワークリクエストがフィルタリングされ、そのアクション中に行われたリクエストのみが表示されます。「Show all」ボタンをクリックすると、すべてのネットワークリクエストが再び表示されます。

タイムラインを使用してアクションをフィルタリングするには、開始点をクリックしてエンドポイントまでドラッグします。ネットワークタブもフィルタリングされ、選択されたアクション中に行われたネットワークリクエストのみが表示されます。

### メタデータ

アクションタブの横にあるメタデータタブには、ブラウザ、ビューポートサイズ、テスト時間などのテストに関する詳細情報が表示されます。

### 添付ファイル

「添付ファイル」タブでは、添付ファイルを探索できます。[ビジュアルリグレッションテスト](/docs/test-snapshots)を行っている場合は、画像の差分、実際の画像、期待される画像を調べることでスクリーンショットを比較できます。期待される画像をクリックすると、スライダーを使用して一方の画像をもう一方の上にスライドさせることができ、スクリーンショットの違いを簡単に確認できます。